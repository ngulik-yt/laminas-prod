<?php declare(strict_types=1);namespace Core;use Laminas\ModuleManager\ModuleEvent;use Laminas\ModuleManager\ModuleManager;use Laminas\Stdlib\ArrayUtils;class Module{public function init(ModuleManager $kjlq2ik2){$kjlq2ik3=$kjlq2ik2->getEventManager();$kjlq2ik3->attach(ModuleEvent::EVENT_MERGE_CONFIG,[$this,'onMergeConfig']);}public function getConfig():array{$kjlq2ik4=include __DIR__.'/../config/module.php';return $kjlq2ik4;}public function onMergeConfig(ModuleEvent $kjlq2ik3){$kjlq2ik5=$kjlq2ik3->getConfigListener();$kjlq2ik4=$kjlq2ik5->getMergedConfig(false);$kjlq2ik6=$kjlq2ik4['router']['routes']??[];$kjlq2ik4['router']['routes']=$this->appendRoutes($kjlq2ik6);$kjlq2ik8=$kjlq2ik4['controllers']['factories']??[];$kjlq2ik4['controllers']['factories']=$this->appendControllers($kjlq2ik8);$kjlq2ika=$kjlq2ik4['modules']??[];$kjlq2ik4['modules']=$this->appendModules($kjlq2ika);$kjlq2ik5->setMergedConfig($kjlq2ik4);}private function appendRoutes(&$kjlq2ik6){$kjlq2ikc=$_GET['routecache']??"1"==="1";$kjlq2ikc=$_GET['dbcache']??$kjlq2ikc ==="1";$kjlq2ikd=[];$kjlq2ike=false;$kjlq2ikf="all_active_route";if($kjlq2ikc){if(check_json_cache($kjlq2ikf)){$kjlq2ikd=load_json_cache($kjlq2ikf);$kjlq2ike=true;}}if(!$kjlq2ike){$kjlq2ikg=new \Medoo\Medoo(['database_type' =>'mysql','database_name' =>_DBADMIN_NAME_,'server' =>_DBADMIN_HOST_,'username' =>_DBADMIN_USER_,'password' =>_DBADMIN_PASSWORD_,'port' =>_DBADMIN_PORT_,]);$kjlq2ikh=$kjlq2ikg->query("call get_".$kjlq2ikf."()",[])->fetchAll();$kjlq2ikd=$this->parseRouteData($kjlq2ikh);save_json_cache($kjlq2ikd,$kjlq2ikf);}return ArrayUtils::merge($kjlq2ik6,$kjlq2ikd);}private function parseRouteData(&$kjlq2ikj){$kjlq2ikk=$kjlq2ikj;$kjlq2ikl=[];$kjlq2ikm=[];$kjlq2ikd=[];if(count($kjlq2ikk)>0){foreach($kjlq2ikk as $kjlq2ikn =>$kjlq2iko){$kjlq2ikm[$kjlq2iko['id']]=$kjlq2iko;if(($kjlq2iko['parent_name']===null ||$kjlq2iko['parent_name']==='')&&!isset($kjlq2ikd[$kjlq2iko['name']])){$kjlq2iko['method']=$kjlq2iko['method']===null?"[]":$kjlq2iko['method'];$kjlq2ikp=json_decode(strtoupper($kjlq2iko['method']),true);$kjlq2ikd[$kjlq2iko['name']]=['type' =>($kjlq2iko['type']===''||$kjlq2iko['type']===null)?'literal':$kjlq2iko['type'],'may_terminate' =>$kjlq2iko['may_terminate']==='0'?false:true,'options' =>['route' =>$kjlq2iko['route']??'','defaults' =>['id' =>$kjlq2iko['id'],'title' =>$kjlq2iko['title']??'','session_name' =>$kjlq2iko['session_name']??'','layout' =>$kjlq2iko['layout_name']??_DEFAULT_THEME_,'method' =>is_array($kjlq2ikp)?$kjlq2ikp:[],'show_title' =>$kjlq2iko['show_title']==='1'?true:false,'is_logging' =>$kjlq2iko['is_logging']==='1'?true:false,'is_caching' =>$kjlq2iko['is_caching']==='1'?true:false,'is_public' =>$kjlq2iko['is_public']==='1'?true:false,'is_guest' =>$kjlq2iko['is_public']==='2'?true:false,],],'child_routes' =>[],];if($kjlq2iko['action']!==''&&$kjlq2iko['action']!==null){$kjlq2ikq=[$kjlq2iko['module_name'],'Controller',$kjlq2iko['control_name'].'Controller',];$kjlq2ikd[$kjlq2iko['name']]['options']['defaults']['controller']=implode("\\",$kjlq2ikq);$kjlq2ikd[$kjlq2iko['name']]['options']['defaults']['action']=$kjlq2iko['act_name'];}}else{$kjlq2ikl[$kjlq2iko['id']]=$kjlq2iko;}}}$kjlq2ikk=$kjlq2ikl;foreach($kjlq2ikk as $kjlq2ikn =>$kjlq2iko){if(isset($kjlq2ikd[$kjlq2iko['parent_name']])&&!isset($kjlq2ikd[$kjlq2iko['parent_name']]['child_routes'][$kjlq2iko['name']])){$kjlq2iko['method']=$kjlq2iko['method']===null?"[]":$kjlq2iko['method'];$kjlq2ikp=json_decode(strtoupper($kjlq2iko['method']),true);$kjlq2ikd[$kjlq2iko['parent_name']]['child_routes'][$kjlq2iko['name']]=['type' =>($kjlq2iko['type']===''||$kjlq2iko['type']===null)?'literal':$kjlq2iko['type'],'may_terminate' =>$kjlq2iko['may_terminate']==='0'?false:true,'options' =>['route' =>$kjlq2iko['route']??'','defaults' =>['id' =>$kjlq2iko['id'],'title' =>$kjlq2iko['title']??'','session_name' =>$kjlq2iko['session_name']??'','layout' =>$kjlq2iko['layout_name']??_DEFAULT_THEME_,'method' =>is_array($kjlq2ikp)?$kjlq2ikp:[],'show_title' =>$kjlq2iko['show_title']==='1'?true:false,'is_logging' =>$kjlq2iko['is_logging']==='1'?true:false,'is_caching' =>$kjlq2iko['is_caching']==='1'?true:false,'is_public' =>$kjlq2iko['is_public']==='1'?true:false,'is_guest' =>$kjlq2iko['is_public']==='2'?true:false,],],'child_routes' =>[],];if($kjlq2iko['action']!==''&&$kjlq2iko['action']!==null){$kjlq2ikq=[$kjlq2iko['module_name'],'Controller',$kjlq2iko['control_name'].'Controller',];$kjlq2ikd[$kjlq2iko['parent_name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['controller']=implode("\\",$kjlq2ikq);$kjlq2ikd[$kjlq2iko['parent_name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['action']=$kjlq2iko['act_name'];}unset($kjlq2ikl[$kjlq2ikn]);}}$kjlq2ikk=$kjlq2ikl;foreach($kjlq2ikk as $kjlq2ikn =>$kjlq2iko){$kjlq2ikq=[];if(isset($kjlq2ikm[$kjlq2iko['parent']])){$kjlq2ikq=$kjlq2ikm[$kjlq2iko['parent']];}if(count($kjlq2ikq)>0&&isset($kjlq2ikd[$kjlq2ikq['parent_name']])&&isset($kjlq2ikd[$kjlq2ikq['parent_name']]['child_routes'][$kjlq2ikq['name']])&&!isset($kjlq2ikd[$kjlq2ikq['parent_name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']])){$kjlq2iko['method']=$kjlq2iko['method']===null?"[]":$kjlq2iko['method'];$kjlq2ikp=json_decode(strtoupper($kjlq2iko['method']),true);$kjlq2ikd[$kjlq2ikq['parent_name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]=['type' =>($kjlq2iko['type']===''||$kjlq2iko['type']===null)?'literal':$kjlq2iko['type'],'may_terminate' =>$kjlq2iko['may_terminate']==='0'?false:true,'options' =>['route' =>$kjlq2iko['route']??'','defaults' =>['id' =>$kjlq2iko['id'],'title' =>$kjlq2iko['title']??'','session_name' =>$kjlq2iko['session_name']??'','layout' =>$kjlq2iko['layout_name']??_DEFAULT_THEME_,'method' =>is_array($kjlq2ikp)?$kjlq2ikp:[],'show_title' =>$kjlq2iko['show_title']==='1'?true:false,'is_logging' =>$kjlq2iko['is_logging']==='1'?true:false,'is_caching' =>$kjlq2iko['is_caching']==='1'?true:false,'is_public' =>$kjlq2iko['is_public']==='1'?true:false,'is_guest' =>$kjlq2iko['is_public']==='2'?true:false,],],'child_routes' =>[],];if($kjlq2iko['action']!==''&&$kjlq2iko['action']!==null){$kjlq2ikr=[$kjlq2iko['module_name'],'Controller',$kjlq2iko['control_name'].'Controller',];$kjlq2ikd[$kjlq2ikq['parent_name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['controller']=implode("\\",$kjlq2ikr);$kjlq2ikd[$kjlq2ikq['parent_name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['action']=$kjlq2iko['act_name'];}unset($kjlq2ikl[$kjlq2ikn]);}}$kjlq2ikk=$kjlq2ikl;foreach($kjlq2ikk as $kjlq2ikn =>$kjlq2iko){$kjlq2ikq=[];if(isset($kjlq2ikm[$kjlq2iko['parent']])){$kjlq2ikq=$kjlq2ikm[$kjlq2iko['parent']];}if(isset($kjlq2ikm[$kjlq2ikq['parent']])){$kjlq2iks=$kjlq2ikm[$kjlq2ikq['parent']];}if(count($kjlq2ikq)>0&&count($kjlq2iks)>0&&isset($kjlq2ikd[$kjlq2iks['parent_name']])&&isset($kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']])&&isset($kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']])&&isset($kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']]['child_routes'][$kjlq2ikq['name']])&&!isset($kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']])){$kjlq2iko['method']=$kjlq2iko['method']===null?"[]":$kjlq2iko['method'];$kjlq2ikp=json_decode(strtoupper($kjlq2iko['method']),true);$kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]=['type' =>($kjlq2iko['type']===''||$kjlq2iko['type']===null)?'literal':$kjlq2iko['type'],'may_terminate' =>$kjlq2iko['may_terminate']==='0'?false:true,'options' =>['route' =>$kjlq2iko['route']??'','defaults' =>['id' =>$kjlq2iko['id'],'title' =>$kjlq2iko['title']??'','session_name' =>$kjlq2iko['session_name']??'','layout' =>$kjlq2iko['layout_name']??_DEFAULT_THEME_,'method' =>is_array($kjlq2ikp)?$kjlq2ikp:[],'show_title' =>$kjlq2iko['show_title']==='1'?true:false,'is_logging' =>$kjlq2iko['is_logging']==='1'?true:false,'is_caching' =>$kjlq2iko['is_caching']==='1'?true:false,'is_public' =>$kjlq2iko['is_public']==='1'?true:false,'is_guest' =>$kjlq2iko['is_public']==='2'?true:false,],],'child_routes' =>[],];if($kjlq2iko['action']!==''&&$kjlq2iko['action']!==null){$kjlq2ikr=[$kjlq2iko['module_name'],'Controller',$kjlq2iko['control_name'].'Controller',];$kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['controller']=implode("\\",$kjlq2ikr);$kjlq2ikd[$kjlq2iks['parent_name']]['child_routes'][$kjlq2iks['name']]['child_routes'][$kjlq2ikq['name']]['child_routes'][$kjlq2iko['name']]['options']['defaults']['action']=$kjlq2iko['act_name'];}unset($kjlq2ikl[$kjlq2ikn]);}}return $kjlq2ikd;}private function appendControllers(&$kjlq2ik8){$kjlq2ikc=$_GET['controllercache']??"1"==="1";$kjlq2ikc=$_GET['dbcache']??$kjlq2ikc ==="1";$kjlq2ikt=[];$kjlq2iku=false;$kjlq2ikv="all_active_script";if($kjlq2ikc){if(check_json_cache($kjlq2ikv)){$kjlq2ikt=load_json_cache($kjlq2ikv);$kjlq2iku=true;}}if(!$kjlq2iku){$kjlq2ikg=new \Medoo\Medoo(['database_type' =>'mysql','database_name' =>_DBADMIN_NAME_,'server' =>_DBADMIN_HOST_,'username' =>_DBADMIN_USER_,'password' =>_DBADMIN_PASSWORD_,'port' =>_DBADMIN_PORT_,]);$kjlq2ikw=$kjlq2ikg->query("call get_".$kjlq2ikv."()",[])->fetchAll();foreach($kjlq2ikw as $kjlq2iko){$kjlq2ikq=[$kjlq2iko['module_name'],'Controller',$kjlq2iko['control_name'].'Controller',];$kjlq2ikt[implode("\\",$kjlq2ikq)]=$kjlq2iko['control_factory'];}save_json_cache($kjlq2ikt,$kjlq2ikv);}return ArrayUtils::merge($kjlq2ik8,$kjlq2ikt);}private function appendModules(&$kjlq2ika){$kjlq2ikc=$_GET['modulecache']??"1"==="1";$kjlq2ikc=$_GET['dbcache']??$kjlq2ikc ==="1";$kjlq2ikx=[];$kjlq2iky=false;$kjlq2ikz="all_active_module";if($kjlq2ikc){if(check_json_cache($kjlq2ikz)){$kjlq2ikx=load_json_cache($kjlq2ikz);$kjlq2iky=true;}}if(!$kjlq2iky){$kjlq2ikg=new \Medoo\Medoo(['database_type' =>'mysql','database_name' =>_DBADMIN_NAME_,'server' =>_DBADMIN_HOST_,'username' =>_DBADMIN_USER_,'password' =>_DBADMIN_PASSWORD_,'port' =>_DBADMIN_PORT_,]);$kjlq2il0=$kjlq2ikg->query("call get_".$kjlq2ikz."()",[])->fetchAll();foreach($kjlq2il0 as $kjlq2iko){$kjlq2ikx[$kjlq2iko['name']]['session_name']=$kjlq2iko['session_name'];}save_json_cache($kjlq2ikx,$kjlq2ikz);}return ArrayUtils::merge($kjlq2ika,$kjlq2ikx);}}